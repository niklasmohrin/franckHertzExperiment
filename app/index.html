<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Franck Hertz Versuch</title>
		<link rel="stylesheet" href="index.css" />
	</head>
	<body>
		<div id="upper-container" class="container">
			<div id="tube-canvas-container" class="container">
				<img src="assets/tube_full.png" id="tube-img" />
			</div>
		</div>
		<div id="lower-container" class="container">
			<div id="graph-container" class="container">
				<div id="graph-canvas-container" class="container"></div>
			</div>

			<div id="controls-container" class="container">
				<div class="input-group">
					<label for="filament">Filament Voltage</label>
					<input
						type="range"
						min="0"
						max="1"
						step="0.0001"
						id="filament"
						class="control"
					/>
				</div>
				<div class="input-group">
					<label for="grid">Grid Voltage</label>
					<input
						type="range"
						min="0"
						max="1"
						step="0.0000001"
						id="grid"
						class="control"
					/>
				</div>
			</div>
		</div>

		<!-- Util functions, constants, inputs -->
		<script>
			const map = (val, xmin, xmax, ymin, ymax) =>
				((val - xmin) / (xmax - xmin)) * (ymax - ymin) + ymin;

			// Set ranges for inputs
			const filamentInput = document.getElementById("filament");
			const gridInput = document.getElementById("grid");

			const FILAMENT_MAX = 10;
			const GRID_MAX = 30;

			filamentInput.setAttribute("max", FILAMENT_MAX);
			gridInput.setAttribute("max", GRID_MAX);

			const GRID_LENGTH = 1;

			// tube: 460px * 208px

			// electron spawning area
			let eSpawnWidth = 40;
			let eSpawnHeight = 70;
			let eSpawnStartX = 80;
			let eSpawnStartY = 25;

			// tube / electron despawn area
			let eLeftBound = 57;
			let eRightBound = 393;
			let eTopBound = 11;
			let eBottomBound = 105;

			// grid position
			let gridX = 315;

			// electron constants
			const ELECTRON_RADIUS = 2; //px
			const ELECTRON_COLOR = "#4e27b2"; //"#640ac8";
			const ELECTRON_MASS = 9e-31;
			const ELECTRON_CHARGE = 1.6e-19;
			const MAX_ELECTRONS = 200;

			// const ELECTRON_LIFETIME = 10000;

			// glow constants
			const GLOW_COLOR = "#ed6517";
			const GLOW_RADIUS = 30;
			const GLOW_FADE = 10;
			const COLLISION_PROB = 5e-1;

			const VEL_DIV = 1e13;

			// energy constraints (Quecksilber)
			const energyLowerBound = 4.7 * ELECTRON_CHARGE;
			const energyUpperBound = 5.3 * ELECTRON_CHARGE;

			const glowEnergy = 4.7 * ELECTRON_CHARGE;

			// handle inputs
			let newEProb = 0;
			filamentInput.addEventListener("input", e => {
				newEProb = filamentInput.value / 20;
				// TODO: add realistic probabilities
				// console.log("fil - change", newEProb);
			});

			let uGrid = 0;

			const f = U =>
				Math.sin(map(U % 4.7, 0, 4.7, 0, (5 / 6) * Math.PI)) * Math.exp(U / 20);
			// TODO: add f(U) to be realistic

			gridInput.addEventListener("input", e => {
				uGrid = e.target.value;
				drawOnGraph();
			});

			// simulation loop
			const SIMULATION_TIMEOUT_MS = 10; // ms
			const SIMULATION_TIMEOUT = SIMULATION_TIMEOUT_MS / 1000;
			// const TIME_STRETCH = 5e11;

			let electrons = [];
		</script>

		<!-- Import p5.js -->

		<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/p5.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/addons/p5.dom.min.js"></script>

		<!-- Import ParticleElectron.js -->
		<script src="ParticleElectron.js"></script>

		<!-- Simulation -->
		<script>
			let prevTime;
			const simulation = () => {
				// const curTime = Date.now();
				// const elapsedTime = curTime - prevTime;
				if (Math.random() < newEProb && electrons.length < MAX_ELECTRONS) {
					// console.log("push");
					electrons.push(new ParticleElectron());
				}

				const curForce = (ELECTRON_CHARGE * uGrid) / GRID_LENGTH / 1e12;
				// console.log(curForce);
				let toRemove = [];

				for (let i = electrons.length - 1; i > -1; i--) {
					// e.loops++;
					// if (e.loops < ELECTRON_LIFETIME) {
					const e = electrons[i];
					if (
						// e.alive &&
						e.x < eRightBound &&
						e.x > eLeftBound &&
						e.y < eBottomBound &&
						e.y > eTopBound
					) {
						// const energy = e.getE();
						const energy =
							ELECTRON_CHARGE *
							(map(e.x, eSpawnStartX, gridX, 0, uGrid) - e.collisions * 4.9);
						// console.log(energy);
						if (
							energy > energyLowerBound &&
							energy < energyUpperBound &&
							e.x < gridX &&
							Math.random() < COLLISION_PROB
						) {
							tubeP5.glow(e.x, e.y);
							e.collisions += 1;
							e.subtractEnergy(energy);
						}

						if (e.x < gridX) e.applyForce(curForce, 0);
						e.update();
					} else {
						toRemove.push(i);
					}
				}

				toRemove.forEach(index => electrons.pop(index));

				// prevTime = Date.now();
			};

			prevTime = Date.now();

			let simulationInterval = setInterval(simulation, SIMULATION_TIMEOUT_MS);
		</script>

		<script src="tubeSketch.js"></script>
		<script src="graphSketch.js"></script>

		<script>
			// Handling resize events
			// only exectutes 250ms after last event
			let resizeTimer;

			window.addEventListener("resize", () => {
				clearTimeout(resizeTimer);
				resizeTimer = setTimeout(() => {
					// console.log("resize");
					tubeP5.reset();
					graphP5.reset();
				}, 250);
			});
		</script>
	</body>
</html>
